# -*- coding: utf-8 -*-

import os.path
import sys
import textwrap

import pytest

from src.csvdiff2 import csvdiff


TEST_DATA_DIR = 'data/e2e_04_file_encoding'

@pytest.mark.skipif(True, reason="[Because I don't know how to handle unicode in python2.]")
def test_file_encoding_utf8(path_to_tests_dir, capfd):

    lhs_csv = os.path.join(path_to_tests_dir, TEST_DATA_DIR, 'left_UTF-8.csv')
    rhs_csv = os.path.join(path_to_tests_dir, TEST_DATA_DIR, 'right_UTF-8.csv')

    sys.argv = ['csvdiff.py', lhs_csv, rhs_csv, '-ac']
    csvdiff.main()

    out, err = capfd.readouterr()
    assert err == ''
    assert out == textwrap.dedent('''
        ============ Report ============

        * All
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
        left_UTF-8.csv                                                                                                 right_UTF-8.csv                                                                                               Column indices with difference
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
        2 ['1', 'å€¤ï¼‘âˆ’ï¼‘', 'ï¼‘ï¼ï¼ï¼‘', 'æ±äº¬', 'ã‚¦ãƒŠãƒ»ã‚»ãƒ©ãƒ»ãƒ‡ã‚£æ±äº¬']                                              !  2 ['1', 'å€¤ï¼‘âˆ’ï¼‘', 'ï¼‘ï¼ï¼ï¼‘', 'æ±äº¬', 'ã‚¦ãƒŠãƒ»ã‚»ãƒ©ãƒ»ãƒ‡ã‚¤æ±äº¬']                                              @ [4]
        3 ['2', 'å€¤ï¼‘âˆ’ï¼’', 'ï¼‘ï¼ï¼ï¼’', 'å¤§é˜ª', 'è¥¿é•·å €ã‚¢ãƒ‘ãƒ¼ãƒˆ']                                                       3 ['2', 'å€¤ï¼‘âˆ’ï¼’', 'ï¼‘ï¼ï¼ï¼’', 'å¤§é˜ª', 'è¥¿é•·å €ã‚¢ãƒ‘ãƒ¼ãƒˆ']                                                  
        4 ['3', 'å€¤ï¼‘âˆ’ï¼“', 'ï¼‘ï¼ï¼ï¼“', 'æ¨ªæµœ', 'ä¼Šå‹¢ä½æœ¨ç”ºãƒ–ãƒ«ãƒ¼ã‚¹ã§ã‚‚æ­Œã£ã¦']                                      !  4 ['3', 'å€¤ï¼‘âˆ’ï¼“', 'ï¼‘ï¼ï¼ï¼“', 'æ¨ªæµœ', 'ä¼Šå‹¢ä½æœ¨ç”ºãƒ–ãƒ«ãƒ¼ã‚ºã§ã‚‚æ­Œã£ã¦']                                      @ [4]
        5 ['4', 'å€¤iâˆ’ï¼”', 'ï¼‘ï¼ï¼ï¼”', 'åŒ—æµ·é“', 'ç¾Šè¹„å±±ã®éº“ğŸŒ±']                                                     !  5 ['4', 'å€¤ï¼‘âˆ’ï¼”', 'ï¼‘ï¼ï¼ï¼”', 'åŒ—æµ·é“', 'ç¾Šè¹„å±±ã®éº“ğŸŒ±']                                                    @ [1]
        6 ['5', 'å€¤ï¼‘âˆ’ï¼•', 'ï¼‘ï¼ï¼ï¼•', 'ä¸‰é‡', 'ä¸‰é‡çœŒä¼Šè³€å¸‚å¿è€…æ‘']                                                !  6 ['5', 'å€¤ï¼‘âˆ’ï¼•', 'ï¼‘ï½ï¼ï¼•', 'äºŒé‡', 'ä¸‰é‡çœŒä¼Šè³€å¸‚å¿è€…æ‘']                                                @ [2, 3]
        7 ['6', 'å€¤ï¼‘âˆ’ï¼–', 'ï¼‘ï¼ï¼ï¼–', 'æ–°æ½Ÿ', 'æ˜Ÿå³ ã®æ£šç”°ğŸŒ™']                                                      !  7 ['6', 'å€¤ï¼‘âˆ’ï¼–', 'ï¼‘ï¼ï¼ï¼–', 'æ–°çƒ', 'æ˜Ÿå³ ã®æ£šç”°ğŸŒŸ']                                                      @ [3, 4]
        8 ['7', 'å€¤ï¼‘âˆ’ï¼—', 'ï¼‘ï¼ï¼ï¼—', 'äº¬éƒ½', 'äº¬éƒ½åºœäº¬éƒ½å¸‚ä¸Šäº¬åŒºä»Šå‡ºå·é€šçƒä¸¸æ±å…¥ä¸Šã‚‹äºŒç­‹ç›®æ±å…¥ä¸‹ã‚‹ç›¸å›½å¯ºé–€å‰ç”º']     8 ['7', 'å€¤ï¼‘âˆ’ï¼—', 'ï¼‘ï¼ï¼ï¼—', 'äº¬éƒ½', 'äº¬éƒ½åºœäº¬éƒ½å¸‚ä¸Šäº¬åŒºä»Šå‡ºå·é€šçƒä¸¸æ±å…¥ä¸Šã‚‹äºŒç­‹ç›®æ±å…¥ä¸‹ã‚‹ç›¸å›½å¯ºé–€å‰ç”º']
        
        * Count & Row number
        same lines           : 2
        left side only    (<): 0 :-- Row Numbers      -->: []
        right side only   (>): 0 :-- Row Numbers      -->: []
        with differences  (!): 5 :-- Row Number Pairs -->: [(2, 2), (4, 4), (5, 5), (6, 6), (7, 7)]
    ''')


@pytest.mark.skipif(True, reason="[Because I don't know how to handle unicode in python2.]")
def test_file_encoding_shift_jis(path_to_tests_dir, capfd):

    lhs_csv = os.path.join(path_to_tests_dir, TEST_DATA_DIR, 'left_Shift_JIS.csv')
    rhs_csv = os.path.join(path_to_tests_dir, TEST_DATA_DIR, 'right_Shift_JIS.csv')

    sys.argv = ['csvdiff.py', lhs_csv, rhs_csv, '-ac', '-e Shift_JIS']
    csvdiff.main()

    out, err = capfd.readouterr()
    assert err == ''
    assert out == textwrap.dedent('''
        ============ Report ============

        * All
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
        left_Shift_JIS.csv                                                                                             right_Shift_JIS.csv                                                                                           Column indices with difference
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
        2 ['1', 'å€¤ï¼‘-ï¼‘', 'ï¼‘ï¼ï¼ï¼‘', 'æ±äº¬', 'ã‚¦ãƒŠãƒ»ã‚»ãƒ©ãƒ»ãƒ‡ã‚£æ±äº¬']                                              !  2 ['1', 'å€¤ï¼‘-ï¼‘', 'ï¼‘ï¼ï¼ï¼‘', 'æ±äº¬', 'ã‚¦ãƒŠãƒ»ã‚»ãƒ©ãƒ»ãƒ‡ã‚¤æ±äº¬']                                              @ [4]
        3 ['2', 'å€¤ï¼‘-ï¼’', 'ï¼‘ï¼ï¼ï¼’', 'å¤§é˜ª', 'è¥¿é•·å €ã‚¢ãƒ‘ãƒ¼ãƒˆ']                                                       3 ['2', 'å€¤ï¼‘-ï¼’', 'ï¼‘ï¼ï¼ï¼’', 'å¤§é˜ª', 'è¥¿é•·å €ã‚¢ãƒ‘ãƒ¼ãƒˆ']                                                  
        4 ['3', 'å€¤ï¼‘-ï¼“', 'ï¼‘ï¼ï¼ï¼“', 'æ¨ªæµœ', 'ä¼Šå‹¢ä½æœ¨ç”ºãƒ–ãƒ«ãƒ¼ã‚¹ã§ã‚‚æ­Œã£ã¦']                                      !  4 ['3', 'å€¤ï¼‘-ï¼“', 'ï¼‘ï¼ï¼ï¼“', 'æ¨ªæµœ', 'ä¼Šå‹¢ä½æœ¨ç”ºãƒ–ãƒ«ãƒ¼ã‚ºã§ã‚‚æ­Œã£ã¦']                                      @ [4]
        5 ['4', 'å€¤i-ï¼”', 'ï¼‘ï¼ï¼ï¼”', 'åŒ—æµ·é“', 'ç¾Šè¹„å±±ã®éº“']                                                       !  5 ['4', 'å€¤ï¼‘-ï¼”', 'ï¼‘ï¼ï¼ï¼”', 'åŒ—æµ·é“', 'ç¾Šè¹„å±±ã®éº“']                                                      @ [1]
        6 ['5', 'å€¤ï¼‘-ï¼•', 'ï¼‘ï¼ï¼ï¼•', 'ä¸‰é‡', 'ä¸‰é‡çœŒä¼Šè³€å¸‚å¿è€…æ‘']                                                !  6 ['5', 'å€¤ï¼‘-ï¼•', 'ï¼‘ï½ï¼ï¼•', 'äºŒé‡', 'ä¸‰é‡çœŒä¼Šè³€å¸‚å¿è€…æ‘']                                                @ [2, 3]
        7 ['6', 'å€¤ï¼‘-ï¼–', 'ï¼‘ï¼ï¼ï¼–', 'æ–°æ½Ÿ', 'æ˜Ÿå³ ã®æ£šç”°']                                                        !  7 ['6', 'å€¤ï¼‘-ï¼–', 'ï¼‘ï¼ï¼ï¼–', 'æ–°çƒ', 'æ˜Ÿå³ ã®æ£šç”°']                                                        @ [3]
        8 ['7', 'å€¤ï¼‘-ï¼—', 'ï¼‘ï¼ï¼ï¼—', 'äº¬éƒ½', 'äº¬éƒ½åºœäº¬éƒ½å¸‚ä¸Šäº¬åŒºä»Šå‡ºå·é€šçƒä¸¸æ±å…¥ä¸Šã‚‹äºŒç­‹ç›®æ±å…¥ä¸‹ã‚‹ç›¸å›½å¯ºé–€å‰ç”º']     8 ['7', 'å€¤ï¼‘-ï¼—', 'ï¼‘ï¼ï¼ï¼—', 'äº¬éƒ½', 'äº¬éƒ½åºœäº¬éƒ½å¸‚ä¸Šäº¬åŒºä»Šå‡ºå·é€šçƒä¸¸æ±å…¥ä¸Šã‚‹äºŒç­‹ç›®æ±å…¥ä¸‹ã‚‹ç›¸å›½å¯ºé–€å‰ç”º']
        
        * Count & Row number
        same lines           : 2
        left side only    (<): 0 :-- Row Numbers      -->: []
        right side only   (>): 0 :-- Row Numbers      -->: []
        with differences  (!): 5 :-- Row Number Pairs -->: [(2, 2), (4, 4), (5, 5), (6, 6), (7, 7)]
    ''')


@pytest.mark.skipif(True, reason="[Because I don't know how to handle unicode in python2.]")
def test_file_encoding_euc_jp(path_to_tests_dir, capfd):

    lhs_csv = os.path.join(path_to_tests_dir, TEST_DATA_DIR, 'left_EUC-JP.csv')
    rhs_csv = os.path.join(path_to_tests_dir, TEST_DATA_DIR, 'right_EUC-JP.csv')

    sys.argv = ['csvdiff.py', lhs_csv, rhs_csv, '-ac', '-e EUC-JP']
    csvdiff.main()

    out, err = capfd.readouterr()
    assert err == ''
    assert out == textwrap.dedent('''
        ============ Report ============

        * All
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
        left_EUC-JP.csv                                                                                                right_EUC-JP.csv                                                                                              Column indices with difference
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
        2 ['1', 'å€¤ï¼‘-ï¼‘', 'ï¼‘ï¼ï¼ï¼‘', 'æ±äº¬', 'ã‚¦ãƒŠãƒ»ã‚»ãƒ©ãƒ»ãƒ‡ã‚£æ±äº¬']                                              !  2 ['1', 'å€¤ï¼‘-ï¼‘', 'ï¼‘ï¼ï¼ï¼‘', 'æ±äº¬', 'ã‚¦ãƒŠãƒ»ã‚»ãƒ©ãƒ»ãƒ‡ã‚¤æ±äº¬']                                              @ [4]
        3 ['2', 'å€¤ï¼‘-ï¼’', 'ï¼‘ï¼ï¼ï¼’', 'å¤§é˜ª', 'è¥¿é•·å €ã‚¢ãƒ‘ãƒ¼ãƒˆ']                                                       3 ['2', 'å€¤ï¼‘-ï¼’', 'ï¼‘ï¼ï¼ï¼’', 'å¤§é˜ª', 'è¥¿é•·å €ã‚¢ãƒ‘ãƒ¼ãƒˆ']                                                  
        4 ['3', 'å€¤ï¼‘-ï¼“', 'ï¼‘ï¼ï¼ï¼“', 'æ¨ªæµœ', 'ä¼Šå‹¢ä½æœ¨ç”ºãƒ–ãƒ«ãƒ¼ã‚¹ã§ã‚‚æ­Œã£ã¦']                                      !  4 ['3', 'å€¤ï¼‘-ï¼“', 'ï¼‘ï¼ï¼ï¼“', 'æ¨ªæµœ', 'ä¼Šå‹¢ä½æœ¨ç”ºãƒ–ãƒ«ãƒ¼ã‚ºã§ã‚‚æ­Œã£ã¦']                                      @ [4]
        5 ['4', 'å€¤i-ï¼”', 'ï¼‘ï¼ï¼ï¼”', 'åŒ—æµ·é“', 'ç¾Šè¹„å±±ã®éº“']                                                       !  5 ['4', 'å€¤ï¼‘-ï¼”', 'ï¼‘ï¼ï¼ï¼”', 'åŒ—æµ·é“', 'ç¾Šè¹„å±±ã®éº“']                                                      @ [1]
        6 ['5', 'å€¤ï¼‘-ï¼•', 'ï¼‘ï¼ï¼ï¼•', 'ä¸‰é‡', 'ä¸‰é‡çœŒä¼Šè³€å¸‚å¿è€…æ‘']                                                !  6 ['5', 'å€¤ï¼‘-ï¼•', 'ï¼‘ï½ï¼ï¼•', 'äºŒé‡', 'ä¸‰é‡çœŒä¼Šè³€å¸‚å¿è€…æ‘']                                                @ [2, 3]
        7 ['6', 'å€¤ï¼‘-ï¼–', 'ï¼‘ï¼ï¼ï¼–', 'æ–°æ½Ÿ', 'æ˜Ÿå³ ã®æ£šç”°']                                                        !  7 ['6', 'å€¤ï¼‘-ï¼–', 'ï¼‘ï¼ï¼ï¼–', 'æ–°çƒ', 'æ˜Ÿå³ ã®æ£šç”°']                                                        @ [3]
        8 ['7', 'å€¤ï¼‘-ï¼—', 'ï¼‘ï¼ï¼ï¼—', 'äº¬éƒ½', 'äº¬éƒ½åºœäº¬éƒ½å¸‚ä¸Šäº¬åŒºä»Šå‡ºå·é€šçƒä¸¸æ±å…¥ä¸Šã‚‹äºŒç­‹ç›®æ±å…¥ä¸‹ã‚‹ç›¸å›½å¯ºé–€å‰ç”º']     8 ['7', 'å€¤ï¼‘-ï¼—', 'ï¼‘ï¼ï¼ï¼—', 'äº¬éƒ½', 'äº¬éƒ½åºœäº¬éƒ½å¸‚ä¸Šäº¬åŒºä»Šå‡ºå·é€šçƒä¸¸æ±å…¥ä¸Šã‚‹äºŒç­‹ç›®æ±å…¥ä¸‹ã‚‹ç›¸å›½å¯ºé–€å‰ç”º']

        * Count & Row number
        same lines           : 2
        left side only    (<): 0 :-- Row Numbers      -->: []
        right side only   (>): 0 :-- Row Numbers      -->: []
        with differences  (!): 5 :-- Row Number Pairs -->: [(2, 2), (4, 4), (5, 5), (6, 6), (7, 7)]
    ''')



